<?php
include "config.php";

$callbackJSONData = file_get_contents('php://input');
$callbackData = json_decode($callbackJSONData, true);

$amount = $callbackData['Body']['stkCallback']['CallbackMetadata']['Item'][0]['Value'];
$mpesa_code = $callbackData['Body']['stkCallback']['CheckoutRequestID'];
$phone = $callbackData['Body']['stkCallback']['CallbackMetadata']['Item'][4]['Value'];

// Update user payment automatically
$conn->query("INSERT INTO payments (user_id, mpesa_code, amount, status) 
VALUES (USER_ID_FROM_PHONE, '$mpesa_code', '$amount', 'approved')");

// Activate user
$conn->query("UPDATE users SET status='active' WHERE phone='$phone'");
?>
