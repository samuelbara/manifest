<?php
$shortcode = "YOUR_PAYBILL";  // replace with your Paybill
$passkey = "YOUR_PASSKEY";     // Safaricom passkey
$phone = $_POST['phone'];      // user phone number
$amount = $_POST['amount'];    // registration fee

$timestamp = date('YmdHis');
$passkey_encoded = base64_encode($shortcode.$passkey.$timestamp);

// Get access token
$curl = curl_init();
curl_setopt($curl, CURLOPT_URL, "https://sandbox.safaricom.co.ke/oauth/v1/generate?grant_type=client_credentials");
curl_setopt($curl, CURLOPT_HTTPHEADER, ["Authorization: Basic " . base64_encode("CONSUMER_KEY:CONSUMER_SECRET")]);
curl_setopt($curl, CURLOPT_RETURNTRANSFER, true);
$response = curl_exec($curl);
$data = json_decode($response);
$token = $data->access_token;
curl_close($curl);

// STK PUSH request
$curl2 = curl_init();
curl_setopt($curl2, CURLOPT_URL, "https://sandbox.safaricom.co.ke/mpesa/stkpush/v1/processrequest");
curl_setopt($curl2, CURLOPT_HTTPHEADER, [
    "Content-Type:application/json",
    "Authorization:Bearer $token"
]);

$curl_post_data = [
  'BusinessShortCode' => $shortcode,
  'Password' => $passkey_encoded,
  'Timestamp' => $timestamp,
  'TransactionType' => 'CustomerPayBillOnline',
  'Amount' => $amount,
  'PartyA' => $phone,
  'PartyB' => $shortcode,
  'PhoneNumber' => $phone,
  'CallBackURL' => 'https://yourdomain.com/mpesa_callback.php',
  'AccountReference' => 'Googlic Registration',
  'TransactionDesc' => 'Googlic Registration Fee'
];

curl_setopt($curl2, CURLOPT_POST, true);
curl_setopt($curl2, CURLOPT_POSTFIELDS, json_encode($curl_post_data));
curl_setopt($curl2, CURLOPT_RETURNTRANSFER, true);
$response2 = curl_exec($curl2);
print_r($response2);
?>
